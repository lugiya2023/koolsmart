"use strict";(self["webpackChunkxiaolou"]=self["webpackChunkxiaolou"]||[]).push([[440],{1440:function(e,t,i){i.r(t),i.d(t,{default:function(){return _}});var n=function(){var e=this,t=e._self._c;return t("div",{staticClass:"main"},[t("div",{staticClass:"panel"},[t("div",{staticClass:"sub-panel"},[t("div",{staticClass:"title"},[t("div",[t("i",{staticClass:"el-icon-arrow-left",on:{click:e.handleEditViewpointBackBtnClick}}),e._v("编辑视角配置 ")])]),t("el-form",{attrs:{"label-width":"80px"}},[t("el-form-item",{attrs:{label:"实体配置"}},[t("el-button",{staticClass:"basic-btn add-entity-btn",attrs:{icon:"el-icon-plus"},on:{click:e.handleAddEntityBtnClick}},[e._v("添加实体设备 ")])],1)],1),t("div",{staticClass:"edit-entity-list"},e._l(e.editViewpoint.entities,(function(i){return t("el-card",{key:i.entity_id,staticClass:"entity-card",attrs:{"body-style":{display:"flex",justifyContent:"space-between",padding:"0px"},shadow:"hover"}},[t("div",{staticClass:"entity-content"},[t("div",{staticClass:"entity-name"},[t("el-tooltip",{attrs:{effect:"dark",content:i.original_name,placement:"top"}},[t("div",[e._v(" "+e._s(i.original_name)+" ")])])],1),e.changeIconEntity&&e.changeIconEntity.entity_id===i.entity_id?t("div",{staticClass:"row-icon-change"},[t("i",{class:`mdi ${e.changeIconEntity.icon.replace(":","-")}`}),t("el-select",{attrs:{placeholder:"请选择图标",filterable:"",size:"mini"},model:{value:e.changeIconEntity.icon,callback:function(t){e.$set(e.changeIconEntity,"icon",t)},expression:"changeIconEntity.icon"}},e._l(e.iconOptions,(function(i){return t("el-option",{key:i,attrs:{label:i,value:i}},[t("i",{class:`mdi ${i.replace(":","-")}`}),t("el-divider",{attrs:{direction:"vertical"}}),t("span",{staticStyle:{"marign-left":"40px"}},[e._v("mdi:"+e._s(i))])],1)})),1),t("el-button",{attrs:{icon:"el-icon-check",type:"primary",size:"mini",plain:""},on:{click:()=>{e.changeIconEntity=void 0}}})],1):t("div",{staticClass:"row-btn"},[t("el-tooltip",{attrs:{effect:"dark",content:"更换图标",placement:"bottom","hide-after":1500}},[t("i",{staticClass:"entity-icon",class:`mdi ${i.icon.replace(":","-")}`,on:{click:()=>{e.handleEntityIconChangeBtnClick(i)}}})]),t("el-checkbox",{model:{value:i.useControl,callback:function(t){e.$set(i,"useControl",t)},expression:"item.useControl"}},[e._v("添加控制")]),t("el-tooltip",{attrs:{effect:"dark",content:"删除实体",placement:"bottom","hide-after":1500}},[t("i",{staticClass:"el-icon-delete",on:{click:()=>{e.handleEntityDeleteBtnClick(i)}}})])],1)]),t("div",{staticClass:"viewpoint-image"},[i.renderPic?t("div",{staticClass:"reanderpic",on:{mouseenter:()=>{e.handleRenderpicHover(i.entity_id)},mouseleave:e.handleRenderpicHoverOut}},[t("div",{directives:[{name:"show",rawName:"v-show",value:e.hoverRenderpic===i.entity_id,expression:"hoverRenderpic === item.entity_id"}],staticClass:"hover-panel"},[t("i",{staticClass:"el-icon-picture-outline",on:{click:()=>{e.handleAddRenderpicBtnClick(i)}}})]),t("el-image",{attrs:{fit:"cover",src:i.renderPic}})],1):t("div",{staticClass:"non-renderpic",on:{click:()=>{e.handleAddRenderpicBtnClick(i)}}},[t("i",{staticClass:"el-icon-plus"}),t("small",[e._v("关联渲染图")])])])])})),1),t("div",{staticClass:"footer-row"},[t("el-button",{staticClass:"warn-btn",attrs:{icon:"el-icon-arrow-left"},on:{click:e.handleEditViewpointBackBtnClick}},[e._v("返回")]),t("el-button",{staticClass:"basic-btn",attrs:{icon:"el-icon-receiving"},on:{click:e.handleEditViewpointSaveBtnClick}},[e._v("暂存")])],1)],1),t("div",{staticClass:"viewpoint-panel"},[t("div",{staticClass:"inner"},[t("el-row",{staticClass:"header-row",attrs:{type:"flex",align:"middle"}},[t("el-input",{attrs:{maxlength:"10","show-word-limit":""},model:{value:e.editViewpoint.name,callback:function(t){e.$set(e.editViewpoint,"name",t)},expression:"editViewpoint.name"}},[t("i",{staticClass:"el-input__icon el-icon-house",attrs:{slot:"prefix"},slot:"prefix"})]),t("el-button",{staticClass:"basic-btn",attrs:{icon:"el-icon-upload2"},on:{click:e.handleUpdateBackgroundBtnClick}},[e._v("更新底图")])],1),t("div",{staticClass:"drag-area",attrs:{id:"dragArea"},on:{dragover:e=>{e.preventDefault()},drop:e.handleDropOver}},[e._l(e.editViewpoint.entities,(function(i){return t("div",{directives:[{name:"show",rawName:"v-show",value:i.useControl,expression:"item.useControl"}],key:"control"+i.entity_id,staticClass:"drag-icon",style:{left:i.controlCfg.position.left,top:i.controlCfg.position.top},attrs:{draggable:!0},on:{dragstart:()=>{e.handleDragStart(i)}}},[t("el-tooltip",{attrs:{content:i.original_name,placement:"top","hide-after":2e3}},[t("div",{class:`mdi ${i.icon.replace(":","-")}`})])],1)})),t("visualize",{attrs:{id:"visualize",imgList:e.visualizeImgs}})],2)],1)])]),t("el-dialog",{staticClass:"basic-dialog",attrs:{title:"Add Entity From Home Assistant",visible:e.addEntityDialogVisible,"modal-append-to-body":!1,width:"1000px"},on:{"update:visible":function(t){e.addEntityDialogVisible=t}}},[t("entity-table",{staticStyle:{height:"450px"},on:{entityAdd:e.handleEntityAdd}})],1),t("el-dialog",{staticClass:"basic-dialog",attrs:{title:"关联渲染图",visible:e.addRenderPicDialogVisble,"modal-append-to-body":!0,width:"1100px"},on:{"update:visible":function(t){e.addRenderPicDialogVisble=t},close:function(t){e.isSettingBackground=!1}}},[t("div",{staticClass:"dialog-renderpic-list"},e._l(e.renderPicInfos,(function(i,n){return t("div",{key:n,staticClass:"renderpic-item",on:{click:()=>{e.selectedRenderpic=i.picUrl}}},[t("input",{directives:[{name:"model",rawName:"v-model",value:e.selectedRenderpic,expression:"selectedRenderpic"}],attrs:{type:"radio"},domProps:{value:i.picUrl,checked:e._q(e.selectedRenderpic,i.picUrl)},on:{change:function(t){e.selectedRenderpic=i.picUrl}}}),t("img",{attrs:{src:i.picUrl}}),t("div",[e._v(e._s(i.picName))])])})),0),t("div",{staticClass:"row-footer",attrs:{slot:"footer"},slot:"footer"},[t("el-button",{staticClass:"basic-btn",on:{click:e.addRenderpicConfirmBtnClick}},[e._v("确定")])],1)])],1)},s=[],a=(i(560),function(){var e=this,t=e._self._c;return t("div",[t("el-table",{staticClass:"local-device-table",attrs:{data:e.filteredEntityList,height:"100%"}},[t("el-table-column",{attrs:{prop:"entity_id",width:"300","show-overflow-tooltip":""},scopedSlots:e._u([{key:"header",fn:function(i){return[e._v(" 实体ID "),t("el-select",{staticClass:"scene-select",attrs:{size:"small",multiple:"",placeholder:"按情景模式筛选"},model:{value:e.selectedScenes,callback:function(t){e.selectedScenes=t},expression:"selectedScenes"}},e._l(e.sceneOptions,(function(e,i){return t("el-option",{key:i,attrs:{label:e.label,value:e.value}})})),1)]}}])}),t("el-table-column",{attrs:{prop:"device_name",width:"300","show-overflow-tooltip":""},scopedSlots:e._u([{key:"header",fn:function(i){return[e._v(" 设备 "),t("el-input",{staticStyle:{width:"50%"},attrs:{size:"small",placeholder:"输入设备名称搜索"},model:{value:e.deviceSearch,callback:function(t){e.deviceSearch=t},expression:"deviceSearch"}})]}}])}),t("el-table-column",{attrs:{prop:"area_id",label:"区域",width:"120","show-overflow-tooltip":""}}),t("el-table-column",{attrs:{prop:"platform",label:"集成",width:"100","show-overflow-tooltip":""}}),t("el-table-column",{scopedSlots:e._u([{key:"default",fn:function(i){return[t("el-button",{staticClass:"basic-btn",attrs:{icon:"el-icon-plus",size:"small"},on:{click:function(t){return e.handleEntityAddBtnClck(i.row)}}},[e._v("添加 ")])]}}])})],1)],1)}),l=[],o={name:"EntityTable",data(){return{deviceSearch:"",selectedScenes:[]}},computed:{filteredEntityList(){let e=this.scenes.filter((e=>this.selectedScenes.includes(e.entity_id))).map((e=>e.attributes["entity_id"])).flatMap((e=>e));return e=[...new Set(e)],this.entityList.filter((t=>(0===e.length||t.entity_id&&e.includes(t.entity_id))&&(!this.deviceSearch||t.device_name&&t.device_name.includes(this.deviceSearch))))},entityList(){const e=this.$store.state.haStore.deviceRegistry,t=this.$store.state.haStore.entityRegistry,i=t.filter((e=>e.device_id));return i.forEach((t=>{if(t["device_id"]){let i=e.filter((e=>e.id===t.device_id));0!==i.length&&(t["device_name"]=i[0].name,t["area_id"]=i[0]["area_id"])}})),i},scenes(){let e=[];const t=this.$store.state.projectStore.selectedProject.id,i=this.$store.state.haStore.entitiesFromSubscribe;for(let n in i)if(i[n].attributes["id"]&&"scene"===n.split(".")[0]){let s=i[n].attributes.id.split("_");"koolsmart"===s[0]&&s[1]===t&&e.push(i[n])}return e},sceneOptions(){return this.scenes.map((e=>({label:e.attributes["friendly_name"],value:e.entity_id})))}},methods:{handleEntityAddBtnClck(e){this.$emit("entityAdd",e)}}},d=o,c=i(1001),r=(0,c.Z)(d,a,l,!1,null,"b635029c",null),p=r.exports,h=function(){var e=this,t=e._self._c;return t("div",{staticClass:"container"},[t("div",{staticClass:"img-content"},[e._l(e.imgList.slice(1),(function(e,i){return t("el-image",{key:i,staticClass:"img",attrs:{draggable:"false",src:e,fit:"cover"}})})),t("el-image",{staticClass:"background-url",attrs:{src:e.imgList[0],fit:"cover"}})],2)])},m=[],u={name:"Visualize",props:["imgList"]},v=u,f=(0,c.Z)(v,h,m,!1,null,"10d5d26c",null),g=f.exports,y=i(2356),b=i(1273),w={name:"EditViewpointView",components:{EntityTable:p,Visualize:g},data(){return{changeIconEntity:void 0,hoverRenderpic:void 0,editViewpoint:void 0,selectedEntity:void 0,draggingEntity:void 0,renderPics:[],renderPicInfos:[],selectedRenderpic:void 0,entityTypeIcons:{light:"mdi:lightbulb",switch:"mdi:light-switch",sensor:"mdi:thermometer-low",binary_sensor:"mdi:thermometer-low",others:"mdi:robot"},iconOptions:["mdi:home","mdi:lamp","mdi:lamps","mdi:ceiling-light","mdi:chandelier","mdi:curtains","mdi:curtains-closed","mdi:desk-lamp","mdi:door","mdi:fan","mdi:fire","mdi:hanger","mdi:kettle","mdi:lock","mdi:motion-sensor","mdi:power","mdi:speaker","mdi:thermometer","mdi:toilet","mdi:video","mdi:water","mdi:window-open-variant","mdi:access-point","mdi:alarm-check","mdi:archive","mdi:bluetooth","mdi:camera-wireless","mdi:car-outline","mdi:cat","mdi:dog","mdi:email-outline","mdi:emoticon-outline","mdi:face-man-profile","mdi:face-woman-profile","mdi:key","mdi:play-circle","mdi:presentation-play","mdi:signal-variant","mdi:sleep","mdi:snowflake","mdi:wifi"],isSettingBackground:!1,addEntityDialogVisible:!1,addRenderPicDialogVisble:!1}},computed:{visualizeImgs(){const e=[];return this.editViewpoint.backgroundUrl&&e.push(this.editViewpoint.backgroundUrl),this.editViewpoint.entities.forEach((t=>{t.renderPic&&e.push(t.renderPic)})),e}},created(){this.editViewpoint=this.$store.state.viewpointStore.editViewpoint,this.renderPics=this.getRenderpics()},methods:{handleEntityIconChangeBtnClick(e){this.changeIconEntity=e},handleRenderpicHoverOut(){this.hoverRenderpic=void 0},handleRenderpicHover(e){this.hoverRenderpic=e},handleEntityDeleteBtnClick(e){this.editViewpoint.entities=this.editViewpoint.entities.filter((t=>t.entity_id!==e.entity_id))},handleEditViewpointSaveBtnClick(){const e=this.$store.state.projectStore.selectedProject;0===e.viewpoints.filter((e=>e.id===this.editViewpoint.id)).length?e.viewpoints.push(this.editViewpoint):e.viewpoints.forEach((e=>{e.id===this.editViewpoint.id&&(e={...this.editViewpoint})})),this.$store.commit("projectStore/setSelectedProject",e),this.$router.push("/project/viewpoint-design")},handleUpdateBackgroundBtnClick(){this.isSettingBackground=!0,this.addRenderPicDialogVisble=!0},async getRenderpics(){const e=this.$store.state.projectStore.selectedProject;let t=await(0,y.gp)({obsDesignId:e.obsDesignId},this.$store.state.koolsmartStore.accountType).then((e=>e.renderPicInfos),(e=>(this.$message.error(e),null)));t&&0!==t.length?this.renderPicInfos=t:(this.$message.warning("该方案下没有可用渲染图!"),this.renderPicInfos=[])},handleAddRenderpicBtnClick(e){"sensor"!==e.entity_id.split(".")[0]&&"binary_sensor"!==e.entity_id.split(".")[0]?(this.selectedEntity=e,this.addRenderPicDialogVisble=!0):this.$message.warning("暂不支持关联传感器")},addRenderpicConfirmBtnClick(){if(this.isSettingBackground)return this.editViewpoint.backgroundUrl=this.selectedRenderpic,void(this.addRenderPicDialogVisble=!1);this.editViewpoint.entities.forEach((e=>{e.entity_id===this.selectedEntity.entity_id&&this.$set(e,"renderPic",this.selectedRenderpic)})),this.addRenderPicDialogVisble=!1},handleSelectedSceneChange(e){const t=this.scenes.filter((t=>e.includes(t.attributes["id"]))).map((e=>e.attributes["entity_id"])),i=new Set(t.flatMap((e=>e)));this.selectedEntities=i,b.log(this.selectedEntities)},handleDragStart(e){this.draggingEntity=e},handleDropOver(e){if(e.offsetX<15||e.offsetY<15)return;let t=document.getElementById("dragArea");const i=t.offsetWidth,n=t.offsetHeight,s=Math.floor((e.offsetY-20)/n*100)+"%",a=Math.floor((e.offsetX-20)/i*100)+"%";this.draggingEntity.controlCfg.position.top=s,this.draggingEntity.controlCfg.position.left=a},handleAddEntityBtnClick(){this.addEntityDialogVisible=!0},handleEntityAdd(e){0===this.editViewpoint.entities.filter((t=>t.entity_id===e.entity_id)).length?this.editViewpoint.entities.unshift({...e,icon:this.entityTypeIcons[e.entity_id.split(".")[0]]??this.entityTypeIcons["others"],useControl:!1,renderPic:"",controlCfg:{position:{top:"50%",left:"50%"}}}):this.$message.warning("实体已添加！")},handleEditViewpointBackBtnClick(){this.$router.push("/project/viewpoint-design")}}},C=w,k=(0,c.Z)(C,n,s,!1,null,"55a9a056",null),_=k.exports}}]);
//# sourceMappingURL=440.acfe4a73.js.map