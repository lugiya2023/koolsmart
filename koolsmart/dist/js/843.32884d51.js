"use strict";(self["webpackChunkxiaolou"]=self["webpackChunkxiaolou"]||[]).push([[843],{843:function(e,t,i){i.r(t),i.d(t,{default:function(){return k}});var s=function(){var e=this,t=e._self._c;return t("div",{staticClass:"main"},[t("el-row",{staticClass:"panel"},[t("el-row",{staticClass:"main-panel"},[t("el-col",{staticClass:"col-viewpoint",attrs:{span:6}},[t("div",{staticClass:"viewpoint-list"},e._l(e.viewpoints,(function(i){return t("div",{key:i.id,staticClass:"viewpoint-card"},[t("el-card",{class:{"viewpoint-image":!0,"selected-image":e.selectedViewpoint&&e.selectedViewpoint.id===i.id},attrs:{"body-style":{padding:"0px"},shadow:"hover"},nativeOn:{click:function(t){return e.handleViewpointCardClick(i)}}},[t("el-image",{attrs:{fit:"cover",src:i.backgroundUrl}})],1),t("div",{class:{"selected-name":e.selectedViewpoint&&e.selectedViewpoint.id===i.id}},[e._v(" "+e._s(i.name)+" ")])],1)})),0)]),t("el-col",{staticClass:"col-main",attrs:{span:18}},[t("el-row",{staticClass:"row-visualize"},[t("Visualize",{staticClass:"visualize",attrs:{imgList:e.imgListForVisualize}})],1),t("el-row",{staticClass:"row-scenes"},[t("div",{staticClass:"content"},e._l(e.scenes,(function(i,s){return t("scene-card",{key:s,staticClass:"scene-item",attrs:{sceneObj:i},on:{active:e.handleSceneActive}})})),1)])],1)],1),t("el-row",{staticClass:"footer-panel"},[t("el-button",{staticClass:"warn-btn",attrs:{icon:"el-icon-back"},on:{click:e.handlePrevStepBtnClick}},[e._v("上一步")]),t("el-button",{staticClass:"basic-btn",attrs:{icon:"el-icon-receiving"},on:{click:e.handleTempSaveBtnClick}},[e._v("存草稿")]),t("el-button",{staticClass:"publish-btn",attrs:{icon:"el-icon-magic-stick"},on:{click:e.handleTestPublishBtnClick}},[e._v("发布")])],1)],1)],1)},a=[],n=(i(560),i(2356)),o=function(){var e=this,t=e._self._c;return t("div",{staticClass:"container"},[t("div",{staticClass:"img-content"},e._l(e.imgList,(function(e,i){return t("el-image",{key:i,staticClass:"img",attrs:{draggable:"false",src:e,fit:"cover"}})})),1)])},c=[],r={name:"Visualize",props:["imgList"]},l=r,d=i(1001),h=(0,d.Z)(l,o,c,!1,null,"20b47aca",null),p=h.exports,u=function(){var e=this,t=e._self._c;return t("el-card",{staticClass:"scene-card",attrs:{shadow:"hover"}},[t("el-row",[t("el-col",{staticClass:"edit-col",attrs:{span:20}},[t("div",[t("i",{class:`mdi ${e.sceneMap.icon.replace(":","-")}`}),e._v(" "+e._s(e.sceneMap.name)+" ")])]),t("el-col",{staticClass:"edit-col",attrs:{span:4}},[t("span",{on:{click:e.handleActiveBtnClick}},[e._v("激活")])])],1)],1)},m=[],b={name:"SceneCard",props:["sceneObj"],data(){return{deviceTypes:["switch","light","sensor"],deviceTypesIcon:{switch:"light-switch",light:"ceiling-light-multiple",sensor:"thermometer",other:"robot"}}},computed:{sceneMap(){let e={};return this.sceneObj.attributes["entity_id"]?.forEach((t=>{let i=t.split(".")[0];this.deviceTypes.includes(i)||(i="other"),e[i]||(e[i]=0),e[i]++})),{name:this.sceneObj.attributes["friendly_name"],icon:this.sceneObj.attributes["icon"]??"home",entity_id:this.sceneObj.entity_id,devices:e}}},methods:{handleActiveBtnClick(){this.$emit("active",this.sceneObj)}}},v=b,g=(0,d.Z)(v,u,m,!1,null,"46a61320",null),f=g.exports,w=i(1273),C={name:"PublishView",components:{Visualize:p,SceneCard:f},data(){return{selectedViewpoint:void 0,selectedScene:void 0,filteredEntities:void 0,transparentImg:"https://hexo-img.obs.cn-east-3.myhuaweicloud.com/llf/transparent.png"}},computed:{imgListForVisualize(){let e=[];return this.selectedViewpoint&&e.push(this.selectedViewpoint.backgroundUrl),this.filteredEntities&&this.selectedViewpoint.entities.forEach((t=>{t.renderPic&&Object.keys(this.filteredEntities).includes(t.entity_id)&&"on"===this.filteredEntities[t.entity_id].state&&e.push(t.renderPic)})),e},viewpoints(){return this.$store.state.projectStore.selectedProject.viewpoints},scenes(){let e=[];const t=this.$store.state.projectStore.selectedProject.id,i=this.$store.state.haStore.entitiesFromSubscribe;for(let s in i)if(i[s].attributes["id"]&&"scene"===s.split(".")[0]){let a=i[s].attributes.id.split("_");"koolsmart"===a[0]&&a[1]===t&&e.push(i[s])}return e}},mounted(){this.viewpoints&&(this.selectedViewpoint=this.viewpoints[0])},methods:{handleTempSaveBtnClick(){const e=this.$store.state.projectStore.projects,t=this.$store.state.projectStore.selectedProject;e.forEach((e=>{e.id===t.id&&(e={...t})})),this.$store.commit("projectStore/setProjects",e),(0,n.Gz)(e).then((e=>{this.$message.success("保存成功"),this.$router.push("/project/index")}),(e=>{w.log(e)}))},handleSceneActive(e){(0,n.VH)({uid:e.attributes.id}).then((e=>{this.selectedScene=e,this.filteredEntities||(this.filteredEntities={});for(let t in e.entities)this.$set(this.filteredEntities,t,e.entities[t])}),(e=>{w.log(e)}))},handlePrevStepBtnClick(){this.$router.push("/project/viewpoint-design")},handleViewpointCardClick(e){this.selectedViewpoint=e},async handleTestPublishBtnClick(){const e=this.$store.state.projectStore.selectedProject,t=this.$store.state.sceneStore.scenes,i=this.buildDashboardConfig(e,t);await this.createKoolSmartDashboard({url:`koolsmart-${e.id}`,name:e.name,icon:e.icon}),this.updateKoolSmartDashboard(`koolsmart-${e.id}`,i)},buildDashboardConfig(e,t){const i={kiosk_mode:{hide_header:!0},views:[]},s={type:"entities",view_layout:{position:"sidebar"},entities:[]},a={type:"vertical-stack",view_layout:{position:"sidebar"},cards:[]};return t.forEach((e=>{const t={entity:e.entity_id};s.entities.push(t)})),e.viewpoints.forEach((t=>{const i={name:t.name,type:"button",show_name:!0,show_icon:!0,tap_action:{action:"navigate",navigation_path:`/koolsmart-${e.id}/${t.id}`},icon:t.icon,icon_height:"30px"};a.cards.push(i)})),e.viewpoints.forEach((e=>{const t=e.entities.filter((e=>e.useControl)).map((e=>({type:"state-icon",icon:e.icon,entity:e.entity_id,tap_action:{action:"toggle"},style:{top:parseFloat(e.controlCfg.position.top)+2+"%",left:parseFloat(e.controlCfg.position.left)+2+"%","border-radius":"50%","background-color":"rgba(40, 40, 40, 0.95)","box-shadow":"0px 0px 8px 3px rgba(160, 160, 160,  0.7)","z-index":10}}))),n=e.entities.filter((e=>e.renderPic)).map((e=>({type:"image",entity:e.entity_id,tap_action:{action:"none"},style:{"pointer-events":"none",top:"50%",left:"50%",width:"100%","mix-blend-mode":"lighten"},state_image:{off:this.transparentImg,on:e.renderPic??""}}))),o={path:e.id,title:e.name,type:"sidebar",cards:[{view_layout:{position:"main"},type:"picture-elements",image:e.backgroundUrl,entities:e.entities.map((e=>e.entity_id)),elements:[...t,...n]},{...s},{...a}]};i.views.push(o)})),i},async updateKoolSmartDashboard(e,t){let i={type:"lovelace/config/save",url_path:e,config:t};this.$store.state.haStore.haWebsocket.sendMessagePromise(i).then((e=>{this.$notify.success({title:"publish dashboard success"}),w.log("updateHADashboardCfg Res",e);const t=this.$store.state.projectStore.projects,i=this.$store.state.projectStore.selectedProject;t.forEach((e=>{e.id===i.id&&(e={...i})})),this.$store.commit("projectStore/setProjects",t),(0,n.Gz)(t)}),(e=>{w.log("updateHADashboardCfg Err",e)}))},async createKoolSmartDashboard({url:e,name:t,icon:i}){let s={type:"lovelace/dashboards/create",url_path:e,mode:"storage",require_admin:!1,show_in_sidebar:!0,title:t,icon:i};await this.$store.state.haStore.haWebsocket.sendMessagePromise(s).then((e=>{w.log("createDashboardCfg Res",e)}),(e=>{w.log("createDashboardCfg Err",e)}))}}},_=C,y=(0,d.Z)(_,s,a,!1,null,"5bc384b0",null),k=y.exports}}]);
//# sourceMappingURL=843.32884d51.js.map